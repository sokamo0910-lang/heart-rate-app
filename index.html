<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Heart Rate Monitor</title>
<style>
body {
  background: #0d0d0d;
  color: #fff;
  font-family: "Inter", sans-serif;
  text-align: center;
  padding: 20px;
}

h1 {
  font-size: 32px;
  margin-bottom: 10px;
  font-weight: 600;
}

#video {
  width: 260px;
  height: 260px;
  border-radius: 50%;
  object-fit: cover;
  border: 4px solid #444;
  margin: 20px auto;
  display: block;
}

.controls {
  margin: 15px 0;
}

select, button, input {
  padding: 10px 15px;
  margin: 5px;
  border-radius: 8px;
  font-size: 16px;
  border: none;
}

button {
  background: #1e90ff;
  color: #fff;
  cursor: pointer;
}

button:disabled {
  opacity: 0.4;
}

#bpmDisplay {
  font-size: 48px;
  font-weight: 700;
  margin-top: 20px;
}
</style>
</head>

<body>
<h1>Heart Rate Monitor</h1>

<video id="video" autoplay playsinline></video>

<div class="controls">
  <label>サンプリングレート: </label>
  <select id="sampleRate">
    <option value="30">30 FPS</option>
    <option value="45">45 FPS</option>
    <option value="60">60 FPS</option>
  </select>
  
  <label>計測時間:</label>
  <select id="duration">
    <option value="60">1分</option>
    <option value="180">3分</option>
    <option value="420">7分</option>
    <option value="600">10分</option>
  </select>
</div>

<button id="startBtn">計測開始</button>
<button id="stopBtn" disabled>停止</button>
<button id="csvBtn" disabled>CSVエクスポート</button>

<h2 id="bpmDisplay">-- BPM</h2>

<script>
let video = document.getElementById("video");
let bpmDisplay = document.getElementById("bpmDisplay");

let brightnessData = [];
let timestamps = [];
let measuring = false;
let track;

async function startCamera() {
  const stream = await navigator.mediaDevices.getUserMedia({
    video: {
      facingMode: "environment"
    }
  });

  video.srcObject = stream;

  // フラッシュON（対応端末のみ）
  track = stream.getVideoTracks()[0];
  const capabilities = track.getCapabilities();
  if (capabilities.torch) {
    await track.applyConstraints({ advanced: [{ torch: true }] });
  }
}

function getFrameBrightness() {
  let canvas = document.createElement("canvas");
  let ctx = canvas.getContext("2d");

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  ctx.drawImage(video, 0, 0);
  let frame = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

  let sum = 0;
  for (let i = 0; i < frame.length; i += 4) {
    sum += frame[i] + frame[i + 1] + frame[i + 2];
  }
  return sum / (frame.length / 4);
}

function detectBPM() {
  if (brightnessData.length < 60) return "--";

  let peaks = [];
  for (let i = 1; i < brightnessData.length - 1; i++) {
    if (brightnessData[i] > brightnessData[i - 1] &&
        brightnessData[i] > brightnessData[i + 1]) {
      peaks.push(timestamps[i]);
    }
  }

  if (peaks.length < 2) return "--";

  let intervals = [];
  for (let i = 1; i < peaks.length; i++) {
    intervals.push(peaks[i] - peaks[i - 1]);
  }

  let avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
  let bpm = 60000 / avgInterval;
  return Math.round(bpm);
}

document.getElementById("startBtn").onclick = async () => {
  await startCamera();

  brightnessData = [];
  timestamps = [];
  measuring = true;

  let sampleRate = parseInt(document.getElementById("sampleRate").value);
  let interval = 1000 / sampleRate;

  document.getElementById("startBtn").disabled = true;
  document.getElementById("stopBtn").disabled = false;
  document.getElementById("csvBtn").disabled = true;

  let startTime = performance.now();

  (function loop() {
    if (!measuring) return;

    let now = performance.now();
    let brightness = getFrameBrightness();

    brightnessData.push(brightness);
    timestamps.push(now - startTime);

    let bpm = detectBPM();
    bpmDisplay.innerText = bpm + " BPM";

    setTimeout(loop, interval);
  })();
};

document.getElementById("stopBtn").onclick = () => {
  measuring = false;
  document.getElementById("startBtn").disabled = false;
  document.getElementById("stopBtn").disabled = true;
  document.getElementById("csvBtn").disabled = false;

  if (track) track.applyConstraints({ advanced: [{ torch: false }] });
};

document.getElementById("csvBtn").onclick = () => {
  let csv = "time(ms),brightness\n";
  for (let i = 0; i < brightnessData.length; i++) {
    csv += `${timestamps[i]},${brightnessData[i]}\n`;
  }

  let blob = new Blob([csv], { type: "text/csv" });
  let link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "heart_rate_data.csv";
  link.click();
};
</script>
</body>
</html>
